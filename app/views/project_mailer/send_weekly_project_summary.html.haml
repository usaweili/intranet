!!!
%html{:xmlns => "http://www.w3.org/1999/xhtml"}
  %head
    %meta{:content => "text/html; charset=utf-8", "http-equiv" => "Content-Type"}/
    %title
    :css
      @media only screen and (max-width:480px){body,table,td,p,a,li,blockquote{-webkit-text-size-adjust:none !important}body{width:100% !important;min-width:100% !important}td[id=bodyCell]{padding:10px !important}table.kmMobileHide{display:none !important}table[class=kmTextContentContainer]{width:100% !important}table[class=kmBoxedTextContentContainer]{width:100% !important}td[class=kmImageContent]{padding-left:0 !important;padding-right:0 !important}img[class=kmImage]{width:100% !important}table[class=kmSplitContentLeftContentContainer],table[class=kmSplitContentRightContentContainer],table[class=kmColumnContainer],td[class=kmVerticalButtonBarContentOuter] table[class=kmButtonBarContent],td[class=kmVerticalButtonCollectionContentOuter] table[class=kmButtonCollectionContent],table[class=kmVerticalButton],table[class=kmVerticalButtonContent]{width:100% !important}td[class=kmButtonCollectionInner]{padding-left:9px !important;padding-right:9px !important;padding-top:9px !important;padding-bottom:0 !important;background-color:transparent !important}td[class=kmVerticalButtonIconContent],td[class=kmVerticalButtonTextContent],td[class=kmVerticalButtonContentOuter]{padding-left:0 !important;padding-right:0 !important;padding-bottom:9px !important}table[class=kmSplitContentLeftContentContainer] td[class=kmTextContent],table[class=kmSplitContentRightContentContainer] td[class=kmTextContent],table[class=kmColumnContainer] td[class=kmTextContent],table[class=kmSplitContentLeftContentContainer] td[class=kmImageContent],table[class=kmSplitContentRightContentContainer] td[class=kmImageContent]{padding-top:9px !important}td[class="rowContainer kmFloatLeft"],td[class="rowContainer kmFloatLeft firstColumn"],td[class="rowContainer kmFloatLeft lastColumn"]{float:left;clear:both;width:100% !important}table[id=templateContainer],table[class=templateRow]{max-width:600px !important;width:100% !important}h1{font-size:24px !important;line-height:130% !important}h2{font-size:20px !important;line-height:130% !important}h3{font-size:18px !important;line-height:130% !important}h4{font-size:16px !important;line-height:130% !important}td[class=kmTextContent]{font-size:14px !important;line-height:130% !important}td[class=kmTextBlockInner] td[class=kmTextContent]{padding-right:18px !important;padding-left:18px !important}table[class="kmTableBlock kmTableMobile"] td[class=kmTableBlockInner]{padding-left:9px !important;padding-right:9px !important}table[class="kmTableBlock kmTableMobile"] td[class=kmTableBlockInner] [class=kmTextContent]{font-size:14px !important;line-height:130% !important;padding-left:4px !important;padding-right:4px !important}}
  %body{:style => "margin:0;padding:0;background-color:#C7C7C7;background-image:url(https://klaviyo.s3.amazonaws.com/company%2FeVAXg2%2Fimages%2Ffooter_lodyas.png);background-repeat:repeat;background-position:left top"}
    %center
      %table#bodyTable{:align => "center", :border => "0", :cellpadding => "0", :cellspacing => "0", :style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0;padding:0;background-image:url(https://klaviyo.s3.amazonaws.com/company%2FeVAXg2%2Fimages%2Ffooter_lodyas.png);background-repeat:repeat;background-position:left top;height:100%;margin:0;width:100%", :width => "100%"}
        %tbody
          %tr
            %td#bodyCell{:align => "center", :style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0;padding-top:50px;padding-left:10px;padding-bottom:10px;padding-right:10px;border-top:0;height:100%;margin:0;width:100%", :valign => "top"}
              %table#templateContainer{:border => "0", :cellpadding => "0", :cellspacing => "0", :style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0;border:0 solid #AAA;background-color:#F4F4F4;border-radius:0", :width => "90%"}
                %tbody
                  %tr
                    %td#templateContainerInner{:style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0;padding:0"}
                      %table{:border => "0", :cellpadding => "0", :cellspacing => "0", :style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :width => "100%"}
                        %tr
                          %td{:align => "center", :style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :valign => "top"}
                            %table.templateRow{:border => "0", :cellpadding => "0", :cellspacing => "0", :style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :width => "100%"}
                              %tbody
                                %tr
                                  %td.rowContainer.kmFloatLeft.firstColumn{:style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :valign => "top", :width => "25%"}
                                    %table.kmImageBlock{:border => "0", :cellpadding => "0", :cellspacing => "0", :style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :width => "100%"}
                                      %tbody.kmImageBlockOuter
                                        %tr
                                          %td.kmImageBlockInner{:style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0;padding:9px;background-color:#1A1515;", :valign => "top"}
                                            %table.kmImageContentContainer{:align => "left", :border => "0", :cellpadding => "0", :cellspacing => "0", :style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :width => "100%"}
                                              %tbody
                                                %tr
                                                  %td.kmImageContent{:style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0;padding:0;padding-top:0px;padding-bottom:0;padding-left:9px;padding-right:9px;", :valign => "top"}
                                                    %img.kmImage{:align => "left", :alt => "", :src => "https://klaviyo.s3.amazonaws.com/company%2FeVAXg2%2Fimages%2Fjoshwhite_b7158f.png", :style => "border:0;height:auto;line-height:100%;outline:none;text-decoration:none;padding-bottom:0;display:inline;vertical-align:bottom;margin-right:0;max-width:300px;padding:6px;", :width => "114"}/
                                  %td.rowContainer.kmFloatLeft.lastColumn{:style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :valign => "top", :width => "75%"}
                                    %table.kmTextBlock{:border => "0", :cellpadding => "0", :cellspacing => "0", :style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :width => "100%"}
                                      %tbody.kmTextBlockOuter
                                        %tr
                                          %td.kmTextBlockInner{:style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0;background-color:#1A1515;", :valign => "top"}
                                            %table.kmTextContentContainer{:align => "left", :border => "0", :cellpadding => "0", :cellspacing => "0", :style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :width => "100%"}
                                              %tbody
                                                %tr
                                                  %td.kmTextContent{:style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0;color:#505050;font-family:Helvetica, Arial;font-size:14px;line-height:150%;text-align:left;color:#FFFFFF;padding-bottom:9px;text-align:left;padding-right:18px;padding-left:18px;padding-top:20px;background-color:#1A1515;", :valign => "top"}
                                                    %p{:style => "margin:0;padding-bottom:1px;text-align: right;"}
                                                      %span{:style => "font-size:24px;"}
                                                        %span{:style => "color: rgb(255, 240, 245);"} Weekly Project Summary
                        %tr
                          %td{:align => "center", :style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :valign => "top"}
                            %table.templateRow{:border => "0", :cellpadding => "0", :cellspacing => "0", :style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :width => "100%"}
                              %tbody
                                %tr
                                  %td.rowContainer.kmFloatLeft{:style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :valign => "top"}
                        %tr
                          %td{:align => "center", :style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :valign => "top"}
                            %table.templateRow{:border => "0", :cellpadding => "0", :cellspacing => "0", :style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :width => "100%"}
                              %tbody
                                %tr
                                  %td.rowContainer.kmFloatLeft{:style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :valign => "top"}
                        %tr
                          %td{:align => "center", :style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :valign => "top"}
                            %table.templateRow{:border => "0", :cellpadding => "0", :cellspacing => "0", :style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :width => "100%"}
                              %tbody
                                %tr
                                  %td.rowContainer.kmFloatLeft{:style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :valign => "top"}
                                    %table.kmTextBlock{:border => "0", :cellpadding => "0", :cellspacing => "0", :style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :width => "100%"}
                                      %tbody.kmTextBlockOuter
                                        %tr
                                          %td.kmTextBlockInner{:style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0;", :valign => "top"}
                                            %table.kmTextContentContainer{:align => "left", :border => "0", :cellpadding => "0", :cellspacing => "0", :style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :width => "100%"}
                                              %tbody
                                                %tr
                                                  %td.kmTextContent{:style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0;color:#505050;font-family:Helvetica, Arial;font-size:14px;line-height:150%;text-align:left;padding-top:9px;padding-bottom:9px;padding-left:18px;padding-right:18px;", :valign => "top"}
                                                    %br
                                                    %p{:style => "margin:0;padding-bottom:1em"}
                                                      Hi Manager(s),
                                                      %br/
                                                    %p
                                                      %b #{@project_name.upcase}
                                                      Weekly Summary ( last captured on
                                                      %b #{Date.today.beginning_of_week.strftime('%A, %d %B %Y')}
                                                      ) : 
                                                      %br
                                                      %hr
                                                      %br
                                                      - @repo_data.each do |repo_name, data|
                                                        %div{style:"color:black"}
                                                          Repository
                                                          %b : #{repo_name}
                                                        %br
                                                        - last_week_data = data.last
                                                        - keys = ["gpa", "test_coverage", "loc", "maintainability", "remediation_minutes", "technical_debt_ratio", "diff_coverage", "ratings"]
                                                        
                                                        %table{border: 1}
                                                          %tr
                                                            %th{style: "padding: 4px 25px;"} Metric
                                                            - data.each do |d|
                                                              %th{style: "padding: 5px;"} #{d.timestamp.strftime('%d %B %Y')}
                                                            - if data.length > 1
                                                              %th{style: "padding: 5px;"} Difference (In last week)

                                                          - keys.each do |metric|
                                                            %tr
                                                              - if ["loc", "ratings"].include? metric
                                                                - diff = data.last[metric].merge(data[data.length-2][metric]) { |k, v1, v2| v1 - v2 } if data.length > 1
                                                                - data.last[metric].each_with_index do |(k, v), i|
                                                                  - color = 'black'
                                                                  - if data.length > 1
                                                                    - color = diff[k] > 0? 'green' : 'red'
                                                                    - color = 'black' if diff[k].zero?
                                                                  - if i == 0
                                                                    %td{style: "padding: 4px 20px;"}
                                                                      %b #{metric.titleize} - #{k.titleize}
                                                                    - data.each do |d|
                                                                      %td{style: "padding: 4px 20px;"}
                                                                        #{d[metric][k] || 0}
                                                                    - if data.length > 1
                                                                      %td{style: "padding: 4px 20px; color:#{color}"} #{diff[k].round(2)}
                                                                  - else
                                                                    %tr
                                                                      %td{style: "padding: 4px 20px;"}
                                                                        %b #{metric.titleize} - #{k.titleize}
                                                                      - data.each do |d|
                                                                        %td{style: "padding: 4px 20px;"} #{d[metric][k] || 0}
                                                                      - if data.length > 1
                                                                        %td{style: "padding: 4px 20px; color:#{color}"} #{diff[k].round(2)}
                                                              - else
                                                                %td{style: "padding: 4px 20px;"}
                                                                  %b #{metric.titleize}
                                                                - data.each do |d|
                                                                  %td{style: "padding: 4px 20px;"} #{d[metric] && d[metric].round(2) || 0}
                                                                - if data.length > 1
                                                                  - if data.last[metric] && data[data.length-2] && data[data.length-2][metric]
                                                                    - difference = (data.last[metric] - data[data.length-2][metric]).round(2)
                                                                    - color = "black"
                                                                    - if difference > 0
                                                                      - if metric == 'technical_debt_ratio'
                                                                        - color = 'red'
                                                                      - else
                                                                        - color = 'green'
                                                                    - if difference < 0
                                                                      - color = 'red'
                                                                    %td{style: "padding: 4px 20px;color:#{color}"} #{difference || 0}
                                                                  - else
                                                                    %td{style: "padding: 4px 20px;"} #{data.last[metric] || 0}
                                                        %br
                                                        %hr
                                                    %br
                                                    %p{:style => "margin:0;padding-bottom:0"}
                                                      Regards,
                                                      %br/
                                                      Josh Software
                        %tr
                          %td{:align => "center", :style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :valign => "top"}
                            %table.templateRow{:border => "0", :cellpadding => "0", :cellspacing => "0", :style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :width => "100%"}
                              %tbody
                                %tr
                                  %td.rowContainer.kmFloatLeft.firstColumn{:style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :valign => "top", :width => "50%"}
                                    %table.kmTextBlock{:border => "0", :cellpadding => "0", :cellspacing => "0", :style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :width => "100%"}
                                      %tbody.kmTextBlockOuter
                                        %tr
                                          %td.kmTextBlockInner{:style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0;", :valign => "top"}
                                            %table.kmTextContentContainer{:align => "left", :border => "0", :cellpadding => "0", :cellspacing => "0", :style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :width => "100%"}
                                              %tbody
                                                %tr
                                                  %td.kmTextContent{:style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0;color:#505050;font-family:Helvetica, Arial;font-size:14px;line-height:150%;text-align:left;padding-top:9px;padding-bottom:9px;padding-left:18px;padding-right:18px;", :valign => "top"}
                                                    %p{:style => "margin:0;padding-bottom:0"}
                                                      %span{:style => "font-size:9px;"}
                                                        %span{:style => "color: rgb(169, 169, 169);"} Copyright Â© 2007 - 2014 Josh Software Pvt. Ltd.
                                                      %span{:style => "font-size:9px;"}
                                                        %span{:style => "color: rgb(169, 169, 169);"}
                                                          %br/
                                                          Email: hr@joshsoftware.com
                        %tr
                          %td{:align => "center", :style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :valign => "top"}
                            %table.templateRow{:border => "0", :cellpadding => "0", :cellspacing => "0", :style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :width => "100%"}
                              %tbody
                                %tr
                                  %td.rowContainer.kmFloatLeft.firstColumn{:style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :valign => "top", :width => "67%"}
                                  %td.rowContainer.kmFloatLeft.lastColumn{:style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :valign => "top", :width => "33%"}
                        %tr
                          %td{:align => "center", :style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :valign => "top"}
                            %table.templateRow{:border => "0", :cellpadding => "0", :cellspacing => "0", :style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :width => "100%"}
                              %tbody
                                %tr
                                  %td.rowContainer.kmFloatLeft.firstColumn{:style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :valign => "top", :width => "50%"}
                                  %td.rowContainer.kmFloatLeft{:style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :valign => "top", :width => "25%"}
                                  %td.rowContainer.kmFloatLeft.lastColumn{:style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :valign => "top", :width => "25%"}
                        %tr
                          %td{:align => "center", :style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :valign => "top"}
                            %table.templateRow{:border => "0", :cellpadding => "0", :cellspacing => "0", :style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :width => "100%"}
                              %tbody
                                %tr
                                  %td.rowContainer.kmFloatLeft{:style => "border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0", :valign => "top"}
